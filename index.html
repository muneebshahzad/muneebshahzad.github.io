<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopify API Connection</title>
</head>
<body>

<div id="status">Connecting to Shopify API...</div>
<div id="orderList">Loading last 5 orders...</div>

<script>
    const storefrontAccessToken = 'f4dd6338e204a10b04e1f0fc418b957e'; // Replace with your actual access token
    const shopifyApiUrl = 'https://alkaramat.myshopify.com/api/2023-10/graphql.json';
    const graphqlQueryShop = `
        {
            shop {
                name
            }
        }
    `;

    const graphqlQueryOrders = `
        {
            customer(customerAccessToken: "${storefrontAccessToken}") {
                orders(last: 5) {
                    edges {
                        node {
                            id
                            name
                            totalPriceV2 {
                                amount
                                currencyCode
                            }
                        }
                    }
                }
            }
        }
    `;

    // Function to format currency
    function formatCurrency(amount, currencyCode) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: currencyCode,
        }).format(amount);
    }

    // Make a request to get shop name
    fetch(shopifyApiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Shopify-Storefront-Access-Token': storefrontAccessToken,
        },
        body: JSON.stringify({ query: graphqlQueryShop }),
    })
    .then(response => response.json())
    .then(data => {
        const shopName = data.data.shop.name;
        document.getElementById('status').innerText = `Succeed! Connected to Shopify API. Shop Name: ${shopName}`;
    })
    .catch(error => {
        console.error('Error:', error.message);
        document.getElementById('status').innerText = 'Failed to connect to Shopify API';
    });

    // Make a request to get the last 5 orders
    fetch(shopifyApiUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Shopify-Storefront-Access-Token': storefrontAccessToken,
        },
        body: JSON.stringify({ query: graphqlQueryOrders }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.errors) {
            throw new Error(`GraphQL error: ${JSON.stringify(data.errors)}`);
        } else {
            const orderListElement = document.getElementById('orderList');
            if (orderListElement) {
                const orders = data.data.customer.orders.edges;
                const ordersHtml = orders.map(order => {
                    return `
                        <div>
                            <strong>Order ID:</strong> ${order.node.id}<br>
                            <strong>Name:</strong> ${order.node.name}<br>
                            <strong>Total Price:</strong> ${formatCurrency(order.node.totalPriceV2.amount, order.node.totalPriceV2.currencyCode)}<br>
                            <br>
                        </div>
                    `;
                }).join('');

                orderListElement.innerHTML = `<h2>Last 5 Orders</h2>${ordersHtml}`;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error.message);
        const orderListElement = document.getElementById('orderList');
        if (orderListElement) {
            orderListElement.innerHTML = 'Failed to fetch orders';
        }
    });
</script>
</body>
</html>
